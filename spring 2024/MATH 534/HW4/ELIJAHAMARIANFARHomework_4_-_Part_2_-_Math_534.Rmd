---
title: "Homework 4 - Part 2 - Math 534"
author: "Elijah Amirianfar"
date: "2024-03-01"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Exercise J-2.4

The data below give the incidence of liver tumors in rats after exposure to various amounts of DDT:

```{r, warning=FALSE}
ddt_data = data.frame("Dose-(ppm)" = c(0,2,10,50,250),
                      "Animals-Tested" = c(111,105,124,104,90),
                      "Tumor-Incidence" = c(4,4,11,13,60))
ddt_data
attach(ddt_data)
```
Assume that the number of tumor incidences follow a binomial distribution with incidence probability that satisfies an Armitage-Doll Model:
$$
\pi = 1-e^{-\beta_0 - \beta_1 x - \beta_2 x^2}
$$
where x denotes the dose in ppm.

## Part a) 

Write an R function to implement the iteratively reweighted least squares algorithm. Use the modified relative error as your convergence criteria with tolerance value of 1e-6. Use your function to obtain the maximum likelihood estimates for $\beta_0, \beta_1, \beta_2$.

```{r, warning=FALSE}
JacfW_binomial = function(beta, X, m){
  xt = X%*%beta # n by 1 of data times beta
  E = exp(-xt) # n by 1 of our exponential function
  p_i = 1 - E # gives us proportion
  f = m * p_i # our Binomial PDF
  J = cbind(m*E, X[,2]*m*E, (X[,3])*m*E) # our beta0, beta1, beta2 matrices
  W = diag(as.numeric(1/(f*(1-p_i)))) # our weights (1 divided by variance of our binomial)
  list(f=f, J=J, W=W)
}

GN = function(y, X, m, beta0, Wt = 1, maxit, tolerr = 1e-6){
  for (it in 1: maxit){
    a = JacfW_binomial(beta0,X,m) 
    J = a$J # returns our jacobian
    f = a$f # returns our function values
    Wt = a$W # returns our weights
    JW = t(J) %*% Wt # returns our Jacobian inverse
    print(sprintf('it = %3.0f   b0 = %6.6f  b1 = %6.6f  b2 = %6.6f',
                  it,beta0[1],beta0[2],beta0[3]))
    
    dir = solve(JW%*%J) %*% JW %*% (y-f)
    # gives us our direction formula
    
    beta_new = beta0 + dir
    # takes beta0 and adds direction to it
  
    mod_rel_error = max(abs(beta0 - beta_new)/abs(pmax(1,abs(beta0))))
    # computes our error
    
    if (mod_rel_error < tolerr) {
      break}
    
    beta0 = beta_new
    # let our initial beta become the new beta
  }
  beta0
}


ddt_data = data.frame("Dose-(ppm)" = c(0,2,10,50,250),
                      "Animals-Tested" = c(111,105,124,104,90),
                      "Tumor-Incidence" = c(4,4,11,13,60))

ddt_data_matrix = as.matrix(ddt_data) # takes our data frame and turns it into matrix

data = ddt_data_matrix # relabel data
n = dim(data)[1] # gets the number of rows
X = cbind(matrix(1,n,1),data[,1],data[,1]^2) # gives us a matrix of covariates - dose of drug
# they are the independent variables that affect the response
# since we have an intercept in our proportion function, we add column of 1s in 1st column
y = (ddt_data_matrix[,3]) # gives our response variable - number of tumors

beta_initial=c(0.01,0.01,0.00001) # initial beta values for b0,b1,b2

a = GN(y, X, m = data[,2], beta_initial, Wt = 1, maxit = 100)
```

Thus, we get the following for our MLEs:

$$
\hat\beta_0 = 0.045944,~~~\hat\beta_1 = 0.001627,~~~\hat\beta_2 = 0.000010
$$

## Part b)

Plot the probability of positive response for doses ranging from 0 to 250, based
on the model that you fit in Part (a). Superimpose this plot by the observed proportions, that is the ratio of number of incidents and the number tested.

```{r,warning=FALSE}
proportion = ddt_data_matrix[,3]/ddt_data_matrix[,2]
ppm = ddt_data_matrix[,1]
plot(ppm,proportion)

t = seq(0,250,.1)
lines(t,1 - exp(-0.045944 - 0.001627*t - 0.000010*t^2),col='red')
```

The plot above shows our ppm (x-axis) plotted against our proportions of tumor incidence versus number of animals tested (y-axis) and the red line is the following equation: 

$\pi = 1 - \exp(-0.045944 - 0.001627x - 0.000010x^2)$
\newpage

## Exercise J-2.5

A scientist studied the effects of a very strong storm in trees in a forest in Minnesota as a function of the tree diameters and the severity of winds in the areas where the trees were located. The data for n = 659 trees is given in the attached file blowBF.txt. 

This dataset consists of the following variables:

D = diameter of the tree

S = severity of the storm at the location of the tree (in the scale of 0 to 1, with 1 being most severe)

y = 0 if the tree survived and 1 if the tree died (blown down)

The goal is to use logistic regression to model the probability that a tree is blown down as a function of log(D) (the logarithm of the diameter of the tree), and the severity of storm S, including an intercept. Note that here $y_1,\cdots,y_n$ is a set of n observations where $y_i \sim Bernoulli(\pi_i)$, where $y_i = 1$ indicates a tree is blown down and $y_i = 0$ if it survived. We model the probability of success $\pi_i$ by the following logit function:

$$
\pi_i(\boldsymbol\beta) = \dfrac{\exp(\mathbf{x}_i^T\boldsymbol\beta)}{1 + \exp(\mathbf{x}_i^T\boldsymbol\beta)},~~~i = 1,\cdots,n
$$

where $\mathbf{x}_i^T$ is a vector of p observed covariates for case i (here we need 3 covariates: the intercept, log(D) and S) and $\boldsymbol\beta = (\beta_1,\cdots,\beta_p)^T$ is a set of p variables to be estimated.

## Part a)

Use the iteratively reweighted least squares program you wrote in the previous problem to obtain the MLEs for the parameters.

```{r, warning=FALSE}
JacfW_bernoulli = function(beta, X){
  xt = X%*%beta # n by 1 of data times beta
  E = exp(xt) # defines exponential function as E
  p_i = E/(1 + E) # gives us proportion
  f = p_i # sets our proportion as our function
  J = cbind(E/(1+E)^2, X[,2]*E/(1+E)^2, X[,3]*E/(1+E)^2) # our beta0, beta1, beta2 matrices
  # here we have the partial derivatives of our proportion wrt beta0, beta1, beta2
  W = diag(as.numeric(1/(p_i*(1-p_i)))) # our weights (1 divided by variance of our bernoulli
  # which is p_i(1-p_i) ) 
  list(f=f, J=J, W=W)
}

GN2 = function(y, X, beta0, Wt = 1, maxit, tolerr = 1e-6){
  for (it in 1: maxit){
    a = JacfW_bernoulli(beta0,X) 
    J = a$J # returns our jacobian
    f = a$f # returns our function values
    Wt = a$W # returns our weights
    JW = t(J) %*% Wt # returns our Jacobian inverse
    print(sprintf('it = %3.0f   b0 = %6.6f  b1 = %6.6f  b2 = %6.6f',
                  it,beta0[1],beta0[2],beta0[3]))
    
    dir = solve(JW%*%J) %*% JW %*% (y-f)
    # gives us our direction formula
    
    beta_new = beta0 + dir
    # takes beta0 and adds direction to it
    
    mod_rel_error = max(abs(beta0 - beta_new)/abs(pmax(1,abs(beta0))))
    # computes our error
    
    if (mod_rel_error < tolerr) {
      break}
    
    beta0 = beta_new
    # let our initial beta become the new beta
  }
  beta0
}

tree_data = read.table('//Users/elijahamirianfar/My Drive/04. CSU FULLERTON 2023-2025/2. Spring 2024/MATH 534/R Code Examples/blowBF.txt', header=T, quote="\"")

n = dim(tree_data)[1] # gets the number of rows
X = cbind(matrix(1,n,1),log(tree_data[,1]),tree_data[,2]) # gives us a matrix of covariates - 
# first column is diameter of tree, 2nd column is severity of storm at location of tree
# 3rd column is whether or not the tree survived
# since we have an intercept in our proportion function, we add column of 1s in 1st column
y = tree_data[,3] # gives our response variable - if the tree fell or not

beta_initial=c(0,0,0) # initial beta values for b0,b1,b2

a = GN2(y, X, beta_initial, Wt = 1, maxit = 100)
```

Thus, we get the following for our MLEs:

$$
\hat\beta_0 = -9.562085,~~~\hat\beta_1 = 3.197563~~~\hat\beta_2 = 4.508593
$$

Which gives us the following for our function:

$$
\pi = \dfrac{\exp(-9.562085 + 3.197563\log(x_{1}) + 4.508593x_{2})}{1 + \exp(-9.562085 + 3.197563\log(x_{1}) + 4.508593x_{2})}
$$

## Part b)

Plot the three-dimensional graph of $\pi(\boldsymbol\beta)$, using your maximum likelihood estimates and as a function of $X_1 = S$ and $X_2 = \log(D)$. For your plot, $X_1$ should range in the interval (0,1) and $X_2$ should range in the range of observed values for $\log(D)$.

```{r, warning=FALSE}
library(plot3D)

tree_data = read.table('//Users/elijahamirianfar/My Drive/04. CSU FULLERTON 2023-2025/2. Spring 2024/MATH 534/R Code Examples/blowBF.txt', header=T, quote="\"")

X_1 = tree_data[,2]
X_2 = log(tree_data[,1])

pi_function = function(X1, X2){
  E = exp(-9.562085 + 3.197563*log(X1) + 4.508593*X2) # defines exponential function as E
  E/(1 + E) 
}

# prepare variables.
x1 = seq(0,1,0.01) # gets our range of X1 to be between 0 and 1
x2 = seq(min(X_2), max(X_2), 0.01) # gets our range of X2 to be between the minimum of
# X2 and the maximum of X2
z = outer(x1, x2, pi_function)

# plot the 3D surface
persp3D(x1, x2, z,
      main="Perspective Plot of our Pi Function",
      xlab = "S",
      ylab = "log(D)",
      zlab = "Function",
      theta = 45, phi = 25)
```

## Part c) 

What does your model predict for the probability that a tree with a diameter of 10 located in an area with wind severity of 0.3 is blown down?

```{r, warning=FALSE}
prediction = pi_function(10,0.3)
prediction
```

Based on our model, the probability that a tree with diameter of 10 in an area with wind severity of 0.3 has a probability of 30% of being blown down.


